summary: Integration tests for bzip2

execute: |
  # rootfs="$(install-slices bzip2_bins)"
  rootfs="$(install-slices bzip2_scripts dash_bins)"
  # mount /dev/null for bzexe and pagers. Touching /dev/null is not enough
  mkdir "${rootfs}"/dev
  mount --rbind /dev "${rootfs}"/dev

  # generate a test file
  echo "this is a test file we use for compression with bzip2" > "${rootfs}/input.txt"
  cp $SHELL "${rootfs}/shell"

  # test compresssion commands
  chroot "${rootfs}" /usr/bin/bzip2 -k input.txt
  chroot "${rootfs}" bzip2 -k shell
  cmp "${rootfs}/input.txt" <(chroot "${rootfs}" bzip2 -d -c input.txt.bz2)
  cmp "${rootfs}/input.txt" <(chroot "${rootfs}" bunzip2 -c input.txt.bz2)
  cmp "${rootfs}/input.txt" <(chroot "${rootfs}" bzcat input.txt.bz2)
  chroot "${rootfs}" bzexe shell
  head -n1 "${rootfs}/shell" | grep "/bin/sh"

  # test text utils
  chroot "${rootfs}" bzcmp input.txt.bz2 input.txt.bz2 | exit_code=$?
  chroot "${rootfs}" bzdiff input.txt.bz2 input.txt.bz2 | exit_code=$?
  chroot "${rootfs}" bzgrep "test" input.txt.bz2
  chroot "${rootfs}" bzfgrep "test" input.txt.bz2
  chroot "${rootfs}" bzegrep "test" input.txt.bz2

  # test bzip2recover
  chroot "${rootfs}" bzip2recover  input.txt.bz2

  # test pagers
  chroot "${rootfs}" bzless "test" input.txt.bz2 > /dev/null
  chroot "${rootfs}" bzmore "test" input.txt.bz2 > /dev/null
